app.service("authService",["$resource","$q","localStorageService","appConst",function(e,t,n,o){var i=e("/:action",{action:"api/auth"},{getLocalAccessToken:{method:"GET",params:{action:"api/auth/localaccesstoken"}},registerExternal:{method:"POST",params:{action:"api/auth/registerexternal"}},resetPassword:{method:"GET",params:{action:"api/auth/password"}},updatePassword:{method:"PUT",params:{action:"api/auth/password"}},update:{method:"PUT"},token:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{action:"token"}}}),r={},s={provider:"",userName:"",email:"",externalAccessToken:"",password:"",confirmPassword:""},a=[],c=[],u=function(e){a.push(e)},h=function(e){c.push(e)},l=function(e){e.length&&e.forEach(function(e){"function"==typeof e&&e()})},d=function(){n.remove("authorizationData"),r.isAuth=!1,r.userName="",r.photoPath=null,l(a)},p=function(e,t){n.set("authorizationData",{token:e,userName:t}),r.isAuth=!0,r.userName=t},f=function(){i.get({},function(e){r.id=e.id,r.firstName=e.firstName,r.lastName=e.lastName,r.sex=e.sex,r.birthDate=e.birthDate,r.phoneNumber=e.phoneNumber,r.joinDate=e.joinDate,r.country=e.country,r.isExternal=e.hasExternalLogins,r.city=e.city,r.photoPath=o.cdnMediaBase+e.photoPath+"?width="+o.userPhotoWidth,l(c)},function(){d()})},m=function(e){var n=t.defer(),o=function(t){p(t.access_token,e.userName),f(),r.isExternal=!1,n.resolve(t)},s=function(e){n.reject(e)};return i.token("grant_type=password&username="+e.userName+"&password="+e.password,o,s),n.promise},g=function(){var e=n.get("authorizationData");e&&(r.isAuth=!0,r.userName=e.userName,f())},v=function(e){var n=t.defer();return i.getLocalAccessToken({provider:e.provider,externalAccessToken:e.externalAccessToken,userId:e.userId},function(e){p(e.access_token,e.userName),f(),r.isExternal=!0,n.resolve(e)},function(e){n.reject(e)}),n.promise},y=function(){return"Bearer "+n.get("authorizationData").token},k=function(e){r.photoPath=o.cdnMediaBase+e+"?width="+o.userPhotoWidth};this.login=m,this.logout=d,this.init=g,this.userData=r,this.externalAuthData=s,this.setPhoto=k,this.getAuthHeader=y,this.obtainAccessToken=v,this.auth=i,this.onLogout=u,this.onGetUserData=h}]),app.factory("chatService",["appConst","$rootScope","$q","$location","$resource","Hub","$interval","$timeout","localStorageService","authService",function(e,t,n,o,i,r,s,a,c,u){function h(e,t,n,o,i){y.chats[e].messages.push({text:o,userName:n,timeLeft:"только что",photo:i,time:new Date,sent:t===v})}function l(e,n,o,i,r){y.open(n,o),y.chats[y.options.selected].messages.push({text:i,userName:y.chats[y.options.selected].title,timeLeft:"только что",photo:r,time:new Date,sent:!1}),t.$apply(),a(function(){g(f)},200)}function d(e,t,n,o){y.open(e),y.chats[y.options.selected].messages.push({text:n,userName:t,timeLeft:"только что",photo:o,time:new Date,sent:!0})}var p=i("/:action",{action:"api/chat"},{privateHistory:{method:"GET",isArray:!0,params:{action:"api/chat/privateHistory"}},privateChats:{method:"GET",isArray:!0,params:{action:"api/chat/privateChats"}}}),f=[],m=function(e){f.push(e)},g=function(e){e.length&&e.forEach(function(e){"function"==typeof e&&e()})},v=c.get("clientId");v||(v="client:"+system.guid.newGuid(),c.set("clientId",v));var y={events:{}};y.chats=[{id:0,title:"Public",messages:[]}];var k,w=function(){y.chats[y.options.selected].messages&&y.chats[y.options.selected].messages.length&&y.chats[y.options.selected].messages.forEach(function(e){var t=new system.time.timeSpan(new Date,new Date(e.time)),n=parseInt(t.getMinutes());e.timeLeft=n>0?n+" мин.":"только что"})},D=function(){p.query({},function(e){e&&e.length&&(e.sort(function(e,t){var n=function(e){var t=new system.time.timeSpan(new Date,new Date(e));return t.timeDiff};return n(e.time)<=n(t.time)}),e.forEach(function(e){var t=parseInt(new system.time.timeSpan(new Date,new Date(e.time)).getMinutes());y.chats[0].messages.push({text:e.message,userName:e.userName,timeLeft:t>0?t+" мин.":"только что",photo:e.photoPath,time:system.time.convertToUTCDate(new Date(e.time)),sent:e.clientId===v})}),g(f))}),k=s(w,6e4)},S=new r("chatHub",{listeners:{sendPublic:function(e,n,o,i){h(0,e,n,o,i),t.$apply(),g(f)},sendPrivate:function(e,t,n,o,i){l(e,t,n,o,i)},sendSelf:function(e,n,o,i){d(e,n,o,i),t.$apply(),g(f)}},methods:["sendAsync","sendPrivateAsync"],errorHandler:function(e){console.error(e)},hubDisconnected:function(){S.connection.lastError&&S.connection.start()},transport:"webSockets",logging:!0});S.connection.qs={userId:u.userData.isAuth?u.userData.id:v};var L=function(){for(var e=1;e<y.chats.length;e++)y.chats.splice(e,1)};return u.onLogout(function(){L(),S.disconnect(),S.connection.qs={userId:v},S.connect()}),u.onGetUserData(function(){S.disconnect(),S.connection.qs={userId:u.userData.id},S.connect(),L(),u.userData.isAuth&&p.privateChats({},function(e){e&&e.length&&(e.forEach(function(t){var n=t.toUserId;n===u.userData.id&&(n=t.fromUserId);var o,i=e.filter(function(e){return e.toUserId===u.userData.id&&e.fromUserId===n||e.fromUserId===u.userData.id&&e.toUserId===n});i.forEach(function(e){e.userName!==u.userData.userName&&(o=e.userName)}),y.open(n,o);var r=parseInt(new system.time.timeSpan(new Date,new Date(t.time)).getMinutes());y.chats[y.options.selected].messages.push({text:t.message,userName:y.chats[y.options.selected].title,timeLeft:r>0?r+" мин.":"только что",photo:t.photoPath,time:new Date(t.time),sent:t.fromUserId===u.userData.id})}),a(function(){g(f)},500))})}),y.send=function(e,t,n){0===y.chats[y.options.selected].id?S.sendAsync(v,t,e,n):S.sendPrivateAsync(y.chats[y.options.selected].id,t,e,n)},y.options={visible:!0,title:"Чат",selected:0},y.init=D,y.open=function(e,t){y.options.visible=!0;var n=y.chats.filter(function(t){return t.id===e});if(n.length){var o=y.chats.getIndexByPropertyValue("id",e);y.options.selected=o}else y.chats.push({id:e,title:t,messages:[]}),y.options.selected=y.chats.length-1},y.events.onMessageAdded=m,D(),y}]),app.service("errorService",["msgConst",function(e){var t=function(t,n){return t&&t.data&&t.data.error_description?t.data.error_description:t.statusText||n||e.LOGIN_UNRECOGNIZED_ERROR},n=function(t,n){return t&&t.data&&t.data.message?t.data.message:t.statusText||n||e.UNEXPECTED_SERVER_ERROR},o=function(e){if(e.data&&e.data.modelState){var t=[];for(var o in e.data.modelState)if(e.data.modelState.hasOwnProperty(o))for(var i=0;i<e.data.modelState[o].length;i++)t.push(e.data.modelState[o][i]);return t.join("; ")}return n(e)};this.parseAuthResponse=t,this.parseDataResponse=n,this.parseFormResponse=o}]),app.service("mapService",["$rootScope","$q","$http","$timeout","$compile","appConst","routeService","statusService","uiGmapGoogleMapApi","uiGmapIsReady",function(e,t,n,o,i,r,s,a,c,u){function h(){w&&w.set("directions",null),D&&D.set("directions",null)}function l(e){j.push(e)}function d(e){B.push(e)}function p(e){q.push(e)}function f(){q.length&&q.forEach(function(e){"function"==typeof e&&e()})}function m(){y&&o(function(){g.event.trigger(y,"resize"),J()},100)}var g,v,y,k,w,D,S,L,_,M,R,E,I,C,A,N,x,P,O,T=[],b=[],G={highlightMyRoutes:!0},U=[{colors:["#047D28","#0FAB3E","#06C941"],markerImage:"content/images/glyphicons-563-person-walking.png"},{colors:["#00CFFD","#00B1FD","#006EFD"],markerImage:"content/images/glyphicons-6-car.png"}],F={highlight:"#FC5400",search:"#E300D4",temp:"#FF5900"},z=[],q=[],j=[],B=[],H=t.defer(),V=t.defer(),W={center:{latitude:49.1451,longitude:35.668},zoom:4,control:{},bounds:{}},K=function(e){for(var t="",n="",o=0;o<e.address_components.length;o++)$.inArray("route",e.address_components[o].types)>=0&&(t=e.address_components[o].short_name),$.inArray("street_number",e.address_components[o].types)>=0&&(n=e.address_components[o].short_name);return t+" "+n},Z=function(e,o,i){if(o&&e.address&&(e.address=I.city+", "+e.address),i)return n.get("https://maps.googleapis.com/maps/api/geocode/json",{params:e});var r=t.defer();return v.geocode(e,function(e,t){t===g.GeocoderStatus.OK?r.resolve(e):r.reject(t)}),r.promise},X=function(e,t,n){y.panTo(new g.LatLng(e,t)),y.setZoom(n)},J=function(){navigator.geolocation.getCurrentPosition(function(e){X(e.coords.latitude,e.coords.longitude,12);var t=new g.LatLng(e.coords.latitude,e.coords.longitude);Z({latLng:t}).then(function(e){I={};for(var t=e[0].address_components,n=0;n<t.length;n++)$.inArray("country",t[n].types)>=0&&(I.country=t[n].short_name),$.inArray("locality",t[n].types)>=0&&(I.city=t[n].short_name)})},function(){},{enableHighAccuracy:!0,timeout:2e3})},Q=function(e,t,n,o,i){var r=n&&n.indexOf("to")>-1?"B":"A",s=n&&n.indexOf("Search")>-1?"EDED0C":"2DE02D",a=new g.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+r+"|"+s,null,null,null,new g.Size(24,37)),c={icon:o||a,latitude:e,longitude:t,title:"Test",options:i?{title:i}:{draggable:!0,animation:g.Animation.DROP}};c.id=n;for(var u=null,h=0;h<b.length;h++)if(b[h].id===n){u=h;break}null!=u?(b[u].latitude=e,b[u].longitude=t):b.push(c)},Y=function(e){for(var t=[],n=e.legs,o=0;o<n.length;o++)for(var i=n[o].steps,r=0;r<i.length;r++)for(var s=i[r].path,a=0;a<s.length;a++)t.push({Lat:s[a].lat(),Lng:s[a].lng()});return{path:t}},ee=function(e,n){var o=t.defer(),i={draggable:!n,preserveViewport:!1,polylineOptions:{strokeColor:n?F.search:F.temp,strokeOpacity:n?.5:1,strokeWeight:7,zIndex:1e3}},r=new g.DirectionsRenderer(i);r.setMap(y),n?D=r:w=r;var s={origin:e.startLatLng,destination:e.endLatLng,travelMode:g.TravelMode.DRIVING},a=new g.DirectionsService;return a.route(s,function(e,t){if(t===g.DirectionsStatus.OK){r.setDirections(e),g.event.addListener(r,"directions_changed",function(){B.length&&B.forEach(function(e){"function"==typeof e&&e(r)})});var n=Y(e.routes[0]);n.totalDistance=e.routes[0].legs[0].distance.value,n.totalDuration=e.routes[0].legs[0].duration.value,o.resolve(n)}o.reject()}),o.promise},te=function(){b=[],"function"==typeof C&&C(b)},ne=function(){for(var e=[],t=0;t<b.length;t++)"fromMarker"!==b[t].id&&"toMarker"!==b[t].id&&e.push(b[t]);b=e,"function"==typeof C&&C(b)},oe=function(){for(var e=[],t=0;t<b.length;t++)"fromSearchMarker"!==b[t].id&&"toSearchMarker"!==b[t].id&&e.push(b[t]);b=e,"function"==typeof C&&C(b)},ie=function(){for(var e=[],t=0;t<b.length;t++)-1===b[t].id.indexOf("_temp")&&e.push(b[t]);b=e,"function"==typeof C&&C(b)},re=function(e){for(var t=[],n=0;n<b.length;n++)-1===b[n].id.indexOf("id_"+e)&&t.push(b[n]);b=t,"function"==typeof C&&C(b)},se=function(){T.forEach(function(e){e.polyline.setMap(null)}),te(),T=[]},ae=function(){ie(),S&&(S.polyline.setMap(null),S=null)},ce=function(e){return e.isCurrentUserRoute&&G.highlightMyRoutes?F.highlight:U[e.type].colors[Math.floor(Math.random()*U[e.type].colors.length+0)]},ue=function(){T.forEach(function(e){e.polyline.setOptions({strokeColor:ce(e.info)})})},he=function(e){T.forEach(function(t){t.info.id===e&&(t.polyline.setMap(null),t.polyline=null)}),T=T.filter(function(e){return null!==e.polyline}),re(e)},le=function(){L&&L.isOpen()&&(L.close(),L=null)},de=function(t,n,r){var a=new g.Polyline({path:t.coords.map(function(e){return new g.LatLng(e.lat,e.lng)}),strokeColor:n?F.highlight:ce(t),strokeOpacity:n?.3:.6,strokeWeight:6});a.setMap(y),g.event.addListener(a,"mouseover",function(t){var n,r=this.getPath().getArray(),a=r[0],c=r[r.length-1];T.forEach(function(e){var t=e.polyline.getPath().getArray();t[0]===a&&t[t.length-1]===c&&(n=e.info)}),k={strokeColor:this.strokeColor,strokeOpacity:this.strokeOpacity,zIndex:1,strokeWeight:5},this.setOptions({strokeColor:"#ffffff",strokeOpacity:1,zIndex:999,strokeWeight:10}),e.highlightedRouteInfo=s.getRouteViewModel(n,!0),e.highlightedRouteInfo.events.onRemove=function(e){return function(){e.remove().then(function(e){he(e),O&&"function"==typeof O&&O(e),le()})}}(e.highlightedRouteInfo);var u="<div><route-view route='highlightedRouteInfo'></route-view></div>",h=i(u)(e);le(),_||(M=o(function(){_&&(L=new g.InfoWindow({disableAutoPan:!1}),L.setPosition(R?new g.LatLng(R.lat()+.003,R.lng()):new g.LatLng(t.latLng.lat()+.003,t.latLng.lng())),L.setContent(h[0]),L.isOpen()||L.open(y)),_=!1},1e3),_=!0)}),g.event.addListener(a,"mousemove",function(e){L&&L.isOpen()&&L.setPosition(new g.LatLng(e.latLng.lat()+.003,e.latLng.lng()))}),g.event.addListener(a,"mouseout",function(){this.setOptions(k),_=!1,o.cancel(M)});var c={polyline:a,info:t};n?S=c:T.push(c);var u=n?"id_"+t.id+"_"+t.startLatLng+"_end_temp":"id_"+t.id+"_"+t.startLatLng+"_end",h=n?"id_"+t.id+"_"+t.endLatLng+"_start_temp":"id_"+t.id+"_"+t.endLatLng+"_start",l=t.coords[t.coords.length-1],d=t.coords[0];Q(l.lat,l.lng,u,U[t.type].markerImage,t.endName),Q(d.lat,d.lng,h,U[t.type].markerImage,t.startName),r&&X(d.lat,d.lng,12)},pe=function(e){C=e},fe=function(e){A=e},me=function(e){N=e},ge=function(e){x=e},ve=function(e){O=e},ye=function(e){P=e},ke=function(e){z.push(e)},we=function(e,n,o){if(e.type!=E||!n||o){E=e.type;var i=t.defer();return h(),ae(),se(),s.resource.query(e,function(e){if(e&&e.length){for(var t=0;t<e.length;t++)n&&de(e[t]);i.resolve(e)}i.resolve(0)}),i.promise}},De=function(){h(),s.resource.mostRecent({},function(e){e&&de(e)})};c.then(function(e){g=e,v=new e.Geocoder}),u.promise().then(function(e){y=W.control.getGMap(),g.event.addListener(y,"mousemove",function(e){R=e.latLng}),initGmapsContextMenu(g);var t={menu:"context_menu",menuSeparator:"context_menu_separator",menuItem:"context_menu_item"},n={id:"map_rightclick",eventName:"menu_item_selected",classNames:t,menuItems:[{label:"Проложить маршрут отсюда",id:"menu_go_from",eventName:"onGoFromClick"},{label:"Проложить маршрут сюда",id:"menu_go_to",eventName:"onGoToClick"},{label:"Искать отсюда",id:"menu_search_from",eventName:"onSearchFromClick"},{label:"Искать сюда",id:"menu_search_to",eventName:"onSearchToClick"},{id:"Separator"},{label:"Сброс",id:"menu_reset",eventName:"onResetClick"}]},o=new googlemaps.ContextMenu(y,n),i=function(e,t,n){Q(e.lat(),e.lng(),t),Z({latlng:e.lat()+","+e.lng(),language:"ru"},!1,!0).then(function(t){t.data.results&&t.data.results.length&&"function"==typeof n&&n(K(t.data.results[0]),e)})},r=function(e){e.length&&e.forEach(function(e){"function"==typeof e&&e()})};g.event.addListener(y,"rightclick",function(e){o.show(e.latLng),V.resolve()}),g.event.addListener(o,"onGoFromClick",function(e){i(e,"fromMarker",A)}),g.event.addListener(o,"onGoToClick",function(e){i(e,"toMarker",N)}),g.event.addListener(o,"onSearchFromClick",function(e){i(e,"fromSearchMarker",x)}),g.event.addListener(o,"onSearchToClick",function(e){i(e,"toSearchMarker",P)}),g.event.addListener(o,"onResetClick",function(){r(z)}),H.resolve(e)});var Se={dragend:function(e,t,n){j.length&&j.forEach(function(o){"function"==typeof o&&o(e,t,n)})}},Le=function(){T.forEach(function(e){e.polyline.setOptions({strokeOpacity:.3})})},_e=function(){T.forEach(function(e){e.polyline.setOptions({strokeOpacity:.6})})};this.refresh=m,this.addRoute=f,this.onAddRoute=p,this.map=W,this.markers=b,this.centerOnMe=J,this.centerMap=X,this.geocode=Z,this.setMarker=Q,this.setRoute=de,this.clearAll=se,this.clearTemp=ae,this.declareRoute=ee,this.ready=H.promise,this.contextMenuReady=V.promise,this.onMapMarkersChanged=pe,this.onFromMarkerSelected=fe,this.onToMarkerSelected=me,this.onSearchFromMarkerSelected=ge,this.onSearchToMarkerSelected=ye,this.onRouteRemoved=ve,this.onResetSelected=ke,this.onMarkerDrag=l,this.onRouteChanged=d,this.clearTempDirection=h,this.removeMarkers=te,this.removeRouteMarkers=ne,this.removeSearchMarkers=oe,this.showRoutes=we,this.showMostRecentRoute=De,this.markerEvents=Se,this.getShortAddress=K,this.maskRoutes=Le,this.unmaskRoutes=_e,this.displayOptions=G,this.updateHighlight=ue,this.removeRoute=he}]),app.service("routeService",["$resource","$q","$modal","chatService","appConst",function(e,t,n,o,i){var r=e("/:action",{action:"api/route"},{mostRecent:{method:"GET",params:{action:"api/route/mostRecent"}}}),s=function(e,s){var a=new hitcher.viewModels.routeViewModel(e);return a.config={showUserPhoto:s},a.photoPath=i.cdnMediaBase+a.photoPath,a.events={onApply:function(){o.open(a.userId,a.driver)}},a.remove=function(){var e=t.defer(),o=this,i=n({template:"app/views/modal/yes-no-dialog.html",show:!1});return i.$scope.title="Удаление маршрута",i.$scope.content="Вы в своём уме?",i.$scope.yes=function(){var t=this;r["delete"]({id:o.model.id},function(){t.$hide(),e.resolve(o.model.id)},function(){this.$hide(),e.reject()})},i.$promise.then(i.show),e.promise},a};this.getRouteViewModel=s,this.resource=r}]),app.service("statusService",["$alert","cfpLoadingBar",function(e,t){var n={message:"",status:"success"},o=function(e,o){t.complete(),n.message=e,n.status=o},i=function(t){e({content:t,placement:"top-right",type:"success",duration:3,show:!0})},r=function(e){o(e,"warning")},s=function(t){e({content:t||"Unable to connect to service",placement:"top-right",type:"danger",duration:3,show:!0})},a=function(e){o(e,"info"),t.start()},c=function(){t.complete(),n.message=""},u=function(t){e({content:t,placement:"top-right",type:"info",duration:3,show:!0})};this.info=u,this.set=o,this.state=n,this.success=i,this.loading=a,this.warning=r,this.error=s,this.clear=c}]),app.service("userService",function(){var e={type:0};this.user=e}),app.service("authInterceptorService",["$q","$location","localStorageService",function(e,t,n){var o=function(e){if(e.headers=e.headers||{},e.url.indexOf("photo")>-1&&(e.headers["Content-Type"]="multipart/form-data"),-1===e.url.indexOf("google")){var t=n.get("authorizationData");t&&(e.headers.Authorization="Bearer "+t.token)}return e},i=function(n){return 401===n.status&&t.path("/login"),e.reject(n)};this.request=o,this.responseError=i}]);