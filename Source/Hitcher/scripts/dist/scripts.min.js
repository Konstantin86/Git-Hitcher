"use strict";var app=angular.module("HitcherApp",["ngRoute","ngResource","ngAnimate","ngSanitize","uiGmapgoogle-maps","ui.bootstrap","ui.bootstrap.tpls","flow","LocalStorageModule","mgcrea.ngStrap.helpers.dateParser","mgcrea.ngStrap","angular-loading-bar","infinite-scroll","SignalR"]);app.run(["authService",function(e){e.init()}]),app.config(function(e){e.when("/map",{controller:"mapController"}),e.when("/home",{controller:"homeController",templateUrl:"app/views/home.html"}),e.when("/login",{controller:"loginController",templateUrl:"/app/views/login.html"}),e.when("/signup",{controller:"signupController",templateUrl:"/app/views/signup.html"}),e.when("/account",{controller:"accountController",templateUrl:"/app/views/account.html"}),e.otherwise({redirectTo:"/home"})}),app.config(function(e){e.interceptors.push("authInterceptorService")}),app.config(["flowFactoryProvider","appConst",function(e,t){e.defaults={target:"/api/blob/upload",testChunks:!1,permanentErrors:[404,500,501],maxChunkRetries:1,chunkRetryInterval:5e3,simultaneousUploads:4,singleFile:!0},e.on("catchAll",function(){console.log("catchAll",arguments)})}]),app.config(function(e){angular.extend(e.defaults,{container:"body",html:!0})}),app.constant("appConst",{cdnMediaBase:"http://az775331.vo.msecnd.net/smartgomedia/",userPhotoWidth:"310",chatPhotoWidth:"66"}),app.constant("msgConst",{HOME_WELCOME:"Yet another fitness results tracker...",HOME_WELCOME_HEADER:"KeepFit",ROUTE_DELETE:"Вы в своём уме???",ACCOUNT_DELETE:"Are you sure you want to delete your account from system?",ACCOUNT_UPDATE_SUCCESS:"User profile is updated successfully",ACCOUNT_PWD_CHANGE_SUCCESS:"User password has been changed successfully",ACCOUNT_ASSOCIATE_SUCCESS:"User has been registered successfully, you will be redicted to workouts page in 2 seconds.",ACCOUNT_ASSOCIATE_FAIL_FORMAT:"Failed to register user due to: {0}.",UNEXPECTED_SERVER_ERROR:"Unexpected error happened",LOGIN_UNRECOGNIZED_ERROR:"Unrecognized error happened during user authentication",LOGIN_PWD_RECOVERY_INSTRUCTIONS:"Provide your e-mail address below and click 'Yes'",LOGIN_PWD_RECOVERY_LINK_SENT_FORMAT:"Password recovery link has been just sent to {0}.",SIGNUP_SUCCESS_FORMAT:"User {0} has been successfully registered in the system. After 5 seconds you will be redirected to login page.",SIGNUP_FAIL_FORMAT:"Failed to register user due to: {0}",SIGNUP_SUCCESS_CONFIRM:"Congratulations. You has just successfully confirmed your email. Now you can login using your credentials. You'll be redirected to login page automatically in 5 seconds."}),app.controller("accountController",function(e,t,n,o,r,a,s){function i(){e.securityFormData={oldPassword:"",password:"",confirmPassword:""}}s.clear(),n.userData.isAuth||t.path("/login");var c=new Date;c.setDate(c.getDate()-4380),e.maxDate=c,e.formData=n.userData,i(),e.photoWidth=r.userPhotoWidth,e.onFilesAdded=function(){return-1===arguments[0][0].file.type.indexOf("image")||arguments[0][0].size>2e7?(s.info("You are allowed to upload only image files up to 20 Mb size"),!1):void(this.$flow.defaults.headers.Authorization=n.getAuthHeader())},e.onUploadProgress=function(){s.loading("Uploading photo...")},e.onUploadSuccess=function(e,t){s.success("User photo is updated successfully"),n.setPhoto(t.split('"').join(""))},e.deleteUserModal={title:"Delete Confirmation",content:a.ACCOUNT_DELETE,yes:function(){var e=this;n.auth["delete"]({},function(){e.$hide(),t.path("/home"),n.logout()},function(e){this.$hide(),s.error(o.parseDataError(e))})}},e.update=function(){n.auth.update(e.formData,function(){s.success(a.ACCOUNT_UPDATE_SUCCESS)},function(e){s.error(o.parseFormResponse(e))})},e.changePassword=function(){n.auth.updatePassword(e.securityFormData,function(){i(),s.success(a.ACCOUNT_PWD_CHANGE_SUCCESS)},function(e){i(),s.error(o.parseFormResponse(e))})}}),app.controller("controlCtrl",function(e,t,n,o){e.controlText="I'm a custom control",e.danger=!1,e.userData=n.userData,e.user=o.user,e.authData=n.userData,e.displayOptions=t.displayOptions,t.ready.then(function(){e.$watch("displayOptions.highlightMyRoutes",function(){t.updateHighlight()})}),e.addRoute=function(){t.addRoute()},e.handleCenterMe=function(){t.centerOnMe()}}),app.controller("homeController",function(e,t,n,o,r,a,s,i,c){var u=e.slides=[];u.push({image:"/content/images/lp_1.jpg",text:"Альтернатива такси есть..."}),u.push({image:"/content/images/lp_2.jpg",text:"Путешевствуйте вместе..."}),u.push({image:"/content/images/lp_3.jpg",text:"Надоело ездить на шестерке?"}),u.push({image:"/content/images/lp_4.jpg",text:"Путешевствуйте между городами и даже странами"}),u.push({image:"/content/images/lp_7.jpg",text:"Найдите попутчика внутри города"}),u.push({image:"/content/images/lp_5.jpg",text:"Надоело ездить на ланосе?"}),u.push({image:"/content/images/lp_6.jpg",text:"Надоело ездить на Тойоте?"}),e.myInterval=5e3}),app.controller("indexController",function(e,t,n,o,r,a,s,i,c){function u(){e.searchModel={from:null,to:null,take:2,disableFilter:!1,hideFilter:!1,currentUserOnly:!1}}function l(t){e.searchModel.routes&&e.searchModel.routes.length&&(e.searchModel.routes=e.searchModel.routes.filter(function(e){return e.model.id!==t}))}var h=c.options;e.chatToggle=function(){h.visible=!h.visible},e.searchAside=null,e.alert={title:"Holy guacamole!",content:"Best check yo self, you're not looking too good.",type:"info"};var d=function(){e.searchAside||(e.searchAside=n({scope:e,backdrop:!1,dismissable:!1,placement:"right",template:"app/views/modal/search.html"}),e.searchAside.$promise.then(function(){e.searchAside.show()}))};e.user=r.user;var p=function(){e.searchAside&&(u(),s.removeSearchMarkers(),s.clearTempDirection(),e.searchAside.hide(),e.searchAside=null,s.showRoutes({type:1-e.user.type},!0,!0))};o.onLogout(p),e.$on("$routeChangeSuccess",function(){e.mapVisible=!arguments[1].loadedTemplateUrl||"/map"===arguments[1].redirectTo,e.mapVisible||p()});var f=function(){t.path("/map"),u(),e.searchModel.hideFilter=!0,e.searchModel.currentUserOnly=!0,d(),e.search()};e.userMenu=[{text:"Профайл",href:"#/account",target:"_self"},{text:"Мои маршруты",click:f},{divider:!0},{text:"Выйти",click:"logout()"}],e.markerEvents=s.markerEvents,s.onMarkerDrag(function(t,n,o){var r=t.position,a=t.key;if("fromSearchMarker"===a||"toSearchMarker"===a){var i={latlng:r.lat()+","+r.lng(),language:"ru"};s.geocode(i,!1,!0).then(function(t){"fromSearchMarker"===a?(e.searchModel.from=t.data.results[0].formatted_address,e.searchModel.startLat=r.lat(),e.searchModel.startLng=r.lng()):"toSearchMarker"===a&&(e.searchModel.to=t.data.results[0].formatted_address,e.searchModel.endLat=r.lat(),e.searchModel.endLng=r.lng())})}}),e.authData=o.userData,e.logout=function(){o.logout(),t.path("/home")},s.ready.then(function(t){e.$watch("user.type",function(t){e.searchAside&&e.hideSearch(),s.showRoutes({type:1-t},!0)})}),s.onRouteRemoved(function(e){l(e)}),s.contextMenuReady.then(function(t){e.$watch("searchModel.startLat",function(t){$("#menu_search_from").length&&($("#menu_search_from")[0].style.display=t?"none":"block"),$("#menu_search_to").length&&($("#menu_search_to")[0].style.display=t?"block":"none");var n=$("#menu_go_from").length&&"none"===$("#menu_go_from")[0].style.display&&e.authData.isAuth||$("#menu_search_from").length&&"none"===$("#menu_search_from")[0].style.display?"block":"none";$("#menu_reset").length&&($("#menu_reset")[0].style.display=n),$(".context_menu_separator").length&&($(".context_menu_separator")[0].style.display=n)}),e.$watch("searchModel.endLat",function(t){$("#menu_search_to").length&&($("#menu_search_to")[0].style.display=e.searchModel.startLat&&e.searchModel.endLat||!e.searchModel.startLat?"none":"block")}),s.onSearchFromMarkerSelected(function(t,n){e.searchModel.from=t,e.searchModel.startLat=n.lat(),e.searchModel.startLng=n.lng(),e.searchModel.startLatLng=n,d()}),s.onSearchToMarkerSelected(function(t,n){e.searchModel.to=t,e.searchModel.endLat=n.lat(),e.searchModel.endLng=n.lng(),e.searchModel.endLatLng=n,d()}),s.onResetSelected(function(){e.searchAside&&e.hideSearch()})}),u(),e.getAddress=function(e){var t={address:e,region:"UA",language:"ru"};return s.geocode(t,!0,!0).then(function(e){return e.data.results})},e.search=function(){e.searchModel.type=1-r.user.type,s.showRoutes(e.searchModel).then(function(t){var n=[],o=null;if(t&&t.length){for(var r=0;r<t.length;r++){var c=a.getRouteViewModel(t[r]);c.canDelete=!1,c.canChat=!1,c.events.mouseenter=function(e){return function(){e.canDelete=e.model.isCurrentUserRoute,e.canChat=!e.model.isCurrentUserRoute,s.setRoute(e.model,!0,!0)}}(c),c.events.mouseout=function(e){return function(){e.canDelete=e.model.isCurrentUserRoute&&e.isActive,e.canChat=!e.model.isCurrentUserRoute&&e.isActive,s.clearTemp()}}(c),c.events.click=function(e){return function(){o&&(o.isActive=!1,o.canDelete=!1,o.canChat=!1),s.clearAll(),e.isActive=!0,e.canDelete=e.model.isCurrentUserRoute,e.canChat=!e.model.isCurrentUserRoute,s.setRoute(e.model,!1,!0),o=e}}(c),c.events.onRemove=function(e){return function(){e.remove().then(function(e){l(e),s.removeRoute(e)})}}(c),n.push(c)}n[0].isActive=!0,n[0].canDelete=n[0].model.isCurrentUserRoute,n[0].canChat=!n[0].model.isCurrentUserRoute,s.setRoute(n[0].model,!1,!0),o=n[0]}else i.info("Подходящих результатов не найдено");e.searchModel.disableFilter=!0,e.searchModel.routes=n}),e.searchModel&&e.searchModel.startLatLng&&e.searchModel.endLatLng&&s.declareRoute(e.searchModel,!0)},e.$on("$typeahead.select",function(t,n){e.searchModel.from===n?s.geocode({address:e.searchModel.from}).then(function(t){var n=t[0].geometry.location;e.searchModel.startLat=n.lat(),e.searchModel.startLng=n.lng(),s.setMarker(n.lat(),n.lng(),"fromSearchMarker"),s.centerMap(n.lat(),n.lng(),12)}):e.searchModel.to===n&&s.geocode({address:e.searchModel.to}).then(function(t){var n=t[0].geometry.location;e.searchModel.endLat=n.lat(),e.searchModel.endLng=n.lng(),s.setMarker(n.lat(),n.lng(),"toSearchMarker"),s.centerMap(n.lat(),n.lng(),12)})}),e.hideSearch=p,e.onSearchClick=function(){e.searchAside?e.searchModel.hideFilter?(u(),s.removeSearchMarkers(),s.clearAll()):e.hideSearch():d()}}),app.controller("loginController",function(e,t,n,o,r,a,s,i){e.formData={userName:"",password:""},e.login=function(){r.login(e.formData).then(function(){t.path("/map")},function(t){e.formData={userName:"",password:""},o.error(a.parseAuthResponse(t))})},e.forgotPasswordModal={title:"Password recovery",editable:!0,input:"",content:i.LOGIN_PWD_RECOVERY_INSTRUCTIONS,yes:function(){var e=this;r.auth.resetPassword({email:e.input,callbackLink:location.protocol+"//"+location.host+"/#/login"},function(){e.$hide(),o.success(system.string.format(i.LOGIN_PWD_RECOVERY_LINK_SENT_FORMAT,e.input))},function(t){e.$hide(),o.error(a.parseDataResponse(t))})}},e.externalLogin=function(t){var n=location.protocol+"//"+location.host+"/authcomplete.html",o="/api/auth/externalLogin?provider="+t+"&response_type=token&client_id=Hitcher&redirect_uri="+n;window.$windowScope=e,window.open(o,"Authenticate Account","location=0,status=0,width=600,height=750")},e.authCompletedCB=function(n){e.$apply(function(){r.obtainAccessToken({provider:n.provider,externalAccessToken:n.external_access_token,userId:n.user_id}).then(function(){t.path("/map")},function(e){o.error(a.parseDataResponse(e))})})}}),app.controller("mapController",function(e,t,n,o,r,a,s,i,c,u,l,h,d,p,f){function m(){var t=new Date;t.setHours(t.getHours()+1);var n=new Date;n.setMonth(n.getMonth()+1),e.route={startName:null,endName:null,name:e.userData.userName,phone:e.userData.phoneNumber,startTime:t,recurrency:!1,recurrencyMode:1,recurrencyWeeklyMon:!0,recurrencyWeeklyTue:!0,recurrencyWeeklyWed:!0,recurrencyWeeklyThr:!0,recurrencyWeeklyFri:!0,recurrencyWeeklySat:!0,recurrencyWeeklySun:!0,recurrencyInterval:1,dueDate:n,recurrencyModes:[{value:0,label:"Каждый день"},{value:1,label:"Каждую неделю"},{value:2,label:"Каждый месяц"}]}}var g,v=!1;e.map=h.map,e.markers=h.markers,e.markerEvents=h.markerEvents,e.userData=l.userData,e.chatOptions=f.options,e.chatMessage="",e.chatMessages=f.all,e.chats=f.chats;var y=function(t){$("#menu_go_from").length&&($("#menu_go_from")[0].style.display=t?e.userData.isAuth?"block":"none":e.userData.isAuth&&"block"===$("#menu_go_from")[0].style.display?"block":"none"),$("#menu_go_to").length&&($("#menu_go_to")[0].style.display=e.userData.isAuth&&"block"===$("#menu_go_to")[0].style.display?"block":"none")};e.$watch("userData.isAuth",function(){y(!0)}),e.$on("$routeChangeSuccess",function(){e.mapVisible=!arguments[1].loadedTemplateUrl||"/map"===arguments[1].redirectTo}),e.$watch("mapVisible",function(t){t?h.refresh():e.hideDriveAside(),y(!0)}),e.user=u.user,h.onMarkerDrag(function(t,n,o){var r=t.position,a=t.key;if("fromMarker"===a||"toMarker"===a){var s={latlng:r.lat()+","+r.lng(),language:"ru"};h.geocode(s,!1,!0).then(function(t){"fromMarker"===a?(e.route.startName=h.getShortAddress(t.data.results[0]),e.route.startLatLng=r):"toMarker"===a&&(e.route.endName=h.getShortAddress(t.data.results[0]),e.route.endLatLng=r)})}});var _=function(){e.route.name=e.userData.userName,e.route.phone=e.userData.phoneNumber,g&&g.$isShown||(g=o({scope:e,backdrop:!1,dismissable:!1,placement:"left",template:"app/views/modal/aside.html"}),g.$promise.then(function(){g.show()}),h.maskRoutes())};e.hideDriveAside=function(){g&&(m(),h.removeRouteMarkers(),h.clearTempDirection(),v=!1,g.hide(),h.unmaskRoutes())},e.toggleAside=function(){g&&g.$isShown?e.hideDriveAside():_()},e.declareRoute=function(){e.route.type=u.user.type,e.route.startLatLng=e.route.startLatLng.lat()+","+e.route.startLatLng.lng(),e.route.endLatLng=e.route.endLatLng.lat()+","+e.route.endLatLng.lng(),e.route.totalDistance=e.route.totalDistanceToSave,e.route.totalDuration=e.route.totalDurationToSave;var t=e.route.totalDistance/1e3;if(t>=10){var n=4;t>50&&75>=t?n=3:t>75&&100>=t?n=2:t>100&&(n=1);for(var o=Math.floor(t*n),r=Math.floor(e.route.path.length/o),a=[],s=0;s<e.route.path.length;s++)(0===s||s===e.route.path.length-1||s%r===0)&&a.push(e.route.path[s]);e.route.path=a}p.resource.save(e.route,function(e){e&&d.success("Route is successfully created."),m(),g.hide(),v=!1,h.showMostRecentRoute()})},e.getAddress=function(e){var t={address:e,region:"UA",language:"ru"};return h.geocode(t,!0,!0).then(function(e){return e.data.results})},h.onMapMarkersChanged(function(t){e.markers=t}),h.onFromMarkerSelected(function(t,n){e.route.startName=t,e.route.startLatLng=n,_()}),h.onToMarkerSelected(function(t,n){e.route.endName=t,e.route.endLatLng=n,_()}),h.onResetSelected(function(){g&&g.$isShown&&e.hideDriveAside()}),h.onAddRoute(function(){g&&g.$isShown?e.hideDriveAside():_()}),l.onLogout(e.hideDriveAside);var D=function(){h.declareRoute(e.route).then(function(t){return t?(e.route.path=t.path,e.route.totalDistanceToSave=t.totalDistance,e.route.totalDistance=Math.floor(t.totalDistance/1e3)+" км, "+t.totalDistance%1e3+" м",e.route.totalDurationToSave=t.totalDuration,e.route.totalDuration=t.totalDuration.toString().toHHMMSS(),h.removeRouteMarkers(),void(v=!0)):(m(),void d.info("Невозможно проложить маршрут."))})};e.$on("$typeahead.select",function(t,n){e.route.startName===n?h.geocode({address:e.route.startName}).then(function(t){var n=t[0].geometry.location;e.route.startLatLng=n,h.setMarker(n.lat(),n.lng(),"fromMarker"),h.centerMap(n.lat(),n.lng(),12),v&&(h.clearTempDirection(),D())}):e.route.endName===n&&h.geocode({address:e.route.endName}).then(function(t){var n=t[0].geometry.location;e.route.endLatLng=n,h.setMarker(n.lat(),n.lng(),"toMarker"),h.centerMap(n.lat(),n.lng(),12),v&&(h.clearTempDirection(),D())})}),h.ready.then(function(){h.centerOnMe(),e.$watch("user.type",function(){g&&g.$isShown&&e.hideDriveAside()})}),h.contextMenuReady.then(function(t){e.$watch("route.startLatLng",function(t){$("#menu_go_from").length&&($("#menu_go_from")[0].style.display=t?"none":"block"),$("#menu_go_to").length&&($("#menu_go_to")[0].style.display=t?"block":"none");var n=$("#menu_go_from").length&&"none"===$("#menu_go_from")[0].style.display&&e.userData.isAuth||$("#menu_search_from").length&&"none"===$("#menu_search_from")[0].style.display?"block":"none";$("#menu_reset").length&&($("#menu_reset")[0].style.display=n),$(".context_menu_separator").length&&($(".context_menu_separator")[0].style.display=n),y()}),e.$watch("route.endLatLng",function(t){$("#menu_go_to").length&&($("#menu_go_to")[0].style.display=e.route.startLatLng&&e.route.endLatLng||!e.route.startLatLng?"none":"block"),y()})}),e.$watch("route.startLatLng",function(t){e.route.endLatLng&&e.route.startLatLng&&!v&&D()}),e.$watch("route.endLatLng",function(t){e.route.endLatLng&&e.route.startLatLng&&!v&&D()}),h.onRouteChanged(function(t){var n=t.getDirections();if(n){for(var o=[],r=n.routes[0].legs,a=0;a<r.length;a++)for(var s=r[a].steps,i=0;i<s.length;i++)for(var c=s[i].path,u=0;u<c.length;u++)o.push({Lat:c[u].lat(),Lng:c[u].lng()});e.route.path=o,e.route.startLatLng=n.mc.origin,e.route.endLatLng=n.mc.destination;var l=n.routes[0].legs[0].distance.value;e.route.totalDistanceToSave=l,e.route.totalDistance=Math.floor(l/1e3)+" км, "+l%1e3+" м";var d=n.routes[0].legs[0].duration.value;e.route.totalDurationToSave=d,e.route.totalDuration=d.toString().toHHMMSS(),h.geocode({latlng:e.route.startLatLng.lat()+","+e.route.startLatLng.lng(),language:"ru"},!1,!0).then(function(t){e.route.startName=h.getShortAddress(t.data.results[0])}),h.geocode({latlng:e.route.endLatLng.lat()+","+e.route.endLatLng.lng(),language:"ru"},!1,!0).then(function(t){e.route.endName=h.getShortAddress(t.data.results[0])})}}),m()}),app.controller("signupController",function(e,t,n,o,r,a,s){s.clear(),e.success=!1,e.submitted=!1,e.formData={userName:"",email:"",password:"",confirmPassword:""},e.signUp=function(){function i(){e.success=!0,s.success(system.string.format(o.SIGNUP_SUCCESS_FORMAT,e.formData.userName));var r=function(){var e=n(function(){n.cancel(e),t.path("/login")},5e3)};r()}function c(e){s.error(r.parseFormResponse(e))}e.submitted=!0,a.logout(),a.auth.save(e.formData,i,c)}}),app.directive("chatView",function(e,t,n){return{restrict:"E",scope:{options:"=",chats:"=",selected:"=",messages:"=",message:"="},templateUrl:"/app/directives/chatView.html",link:function(o,r,a,s,i){o.options||(o.options={visible:!0}),o.messages||(o.messages=[]);var c=function(){var e=$(".msg_container_base")[o.options.selected].scrollHeight;$(".msg_container_base")[o.options.selected].scrollTop=e};n.events.onMessageAdded(c),o.minimize=function(){var e=$(".panel-heading span.icon_minim");e.hasClass("panel-collapsed")?(e.parents(".panel").find(".panel-body").slideDown(),e.removeClass("panel-collapsed"),e.removeClass("glyphicon-plus").addClass("glyphicon-minus")):(e.parents(".panel").find(".panel-body").slideUp(),e.addClass("panel-collapsed"),e.removeClass("glyphicon-minus").addClass("glyphicon-plus"))},o.close=function(){o.options.visible=!1};var u=function(){if(o.message){var r=t.userData.photoPath||e.cdnMediaBase+"default_avatar.png";r=r.split("?width")[0]+"?width="+e.chatPhotoWidth,n.send(o.message,t.userData.userName||"аноним",r),o.message=""}};o.keyPress=function(e){13===e&&u()},o.send=u,$("#myDiv").draggable()}}}),app.directive("disableAnimation",function(e){return{restrict:"A",link:function(t,n,o){o.$observe("disableAnimation",function(t){e.enabled(!t,n)})}}}),app.directive("formatPhone",[function(){return{require:"ngModel",restrict:"A",link:function(e,t,n,o,r){e.$watch("formData.phoneNumber",function(t,n){if(t){t=t.replace(new RegExp("-","g"),"");var o=String(t).split("");if(0!==o.length&&(1!==o.length||"-"!=o[0]&&"."!==o[0])&&(2!==o.length||"-."!==t)){isNaN(t)&&(e.formData.phoneNumber=n);var r=t.replace(/[^\w\s]/gi,"");if(10===r.length){var a=r.replace(/(.{3})/g,"$1-"),s=a.slice(0,-2)+a.slice(-1);e.formData.phoneNumber=s}}}})}}}]),app.directive("numberOnlyInput",function(){return{restrict:"EA",template:'<input name="{{inputName}}" ng-model="inputValue" ng-disabled="ngDisabled" min="1" max="10" type="number" class="form-control input-sm" />',scope:{inputValue:"=",ngDisabled:"=",inputName:"="},link:function(e){e.$watch("inputValue",function(t,n){var o=String(t).split("");0!==o.length&&(1!==o.length||"-"!=o[0]&&"."!==o[0])&&(2!==o.length||"-."!==t)&&isNaN(t)&&(e.inputValue=n)})}}}),app.directive("routeView",function(){return{restrict:"E",scope:{routeInfo:"=route"},templateUrl:"/app/directives/routeView.html"}}),app.directive("routeListView",function(){return{restrict:"E",scope:{routesInfo:"=routelist"},templateUrl:"/app/directives/routeListView.html"}}),function(){this.hitcher=this.hitcher||{}}(),hitcher.viewModels=function(){var e=function(e){this.model=e,this.canDelete=e.isCurrentUserRoute,this.canChat=!e.isCurrentUserRoute,this.startName=e.startName,this.startTime=new Date(Date.parse(e.startTime)).toLocaleString(),this.dueDate=new Date(Date.parse(e.dueDate)).toLocaleString(),this.recurrencyInfo=e.recurrency?e.recurrency.recurrencyInfo:null,this.endName=e.endName,this.driver=e.name,this.userId=e.userId,this.phone=e.phone,this.distance=Math.floor(e.totalDistance/1e3)+" км, "+e.totalDistance%1e3+" м",this.duration=e.totalDuration.toString().toHHMMSS(),this.photoPath=e.photoPath};return{routeViewModel:e}}(),app.service("authService",function(e,t,n,o){var r=e("/:action",{action:"api/auth"},{getLocalAccessToken:{method:"GET",params:{action:"api/auth/localaccesstoken"}},registerExternal:{method:"POST",params:{action:"api/auth/registerexternal"}},resetPassword:{method:"GET",params:{action:"api/auth/password"}},updatePassword:{method:"PUT",params:{action:"api/auth/password"}},update:{method:"PUT"},token:{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},params:{action:"token"}}}),a={},s={provider:"",userName:"",email:"",externalAccessToken:"",password:"",confirmPassword:""},i=[],c=[],u=function(e){i.push(e)},l=function(e){c.push(e)},h=function(e){e.length&&e.forEach(function(e){"function"==typeof e&&e()})},d=function(){n.remove("authorizationData"),a.isAuth=!1,a.userName="",a.photoPath=null,h(i)},p=function(e,t){n.set("authorizationData",{token:e,userName:t}),a.isAuth=!0,a.userName=t},f=function(){r.get({},function(e){a.id=e.id,a.firstName=e.firstName,a.lastName=e.lastName,a.sex=e.sex,a.birthDate=e.birthDate,a.phoneNumber=e.phoneNumber,a.joinDate=e.joinDate,a.country=e.country,a.isExternal=e.hasExternalLogins,a.city=e.city,a.photoPath=o.cdnMediaBase+e.photoPath+"?width="+o.userPhotoWidth,h(c)},function(e){d()})},m=function(e){var n=t.defer(),o=function(t){p(t.access_token,e.userName),f(),a.isExternal=!1,n.resolve(t)},s=function(e){n.reject(e)};return r.token("grant_type=password&username="+e.userName+"&password="+e.password,o,s),n.promise},g=function(){var e=n.get("authorizationData");e&&(a.isAuth=!0,a.userName=e.userName,f())},v=function(e){var n=t.defer();return r.getLocalAccessToken({provider:e.provider,externalAccessToken:e.externalAccessToken,userId:e.userId},function(e){p(e.access_token,e.userName),f(),a.isExternal=!0,n.resolve(e)},function(e){n.reject(e)}),n.promise},y=function(){return"Bearer "+n.get("authorizationData").token},_=function(e){a.photoPath=o.cdnMediaBase+e+"?width="+o.userPhotoWidth};this.login=m,this.logout=d,this.init=g,this.userData=a,this.externalAuthData=s,this.setPhoto=_,this.getAuthHeader=y,this.obtainAccessToken=v,this.auth=r,this.onLogout=u,this.onGetUserData=l}),app.factory("chatService",["appConst","$rootScope","$q","$location","$resource","Hub","$interval","$timeout","localStorageService","authService",function(e,t,n,o,r,a,s,i,c,u){function l(e,t,n,o,r){y.chats[e].messages.push({text:o,userName:n,timeLeft:"только что",photo:r,time:new Date,sent:t===v})}function h(e,n,o,r,a){y.open(n,o),y.chats[y.options.selected].messages.push({text:r,userName:y.chats[y.options.selected].title,timeLeft:"только что",photo:a,time:new Date,sent:!1}),t.$apply(),i(function(){g(f)},200)}function d(e,t,n,o){y.open(e),y.chats[y.options.selected].messages.push({text:n,userName:t,timeLeft:"только что",photo:o,time:new Date,sent:!0})}var p=r("/:action",{action:"api/chat"},{privateHistory:{method:"GET",isArray:!0,params:{action:"api/chat/privateHistory"}},privateChats:{method:"GET",isArray:!0,params:{action:"api/chat/privateChats"}}}),f=[],m=function(e){f.push(e)},g=function(e){e.length&&e.forEach(function(e){"function"==typeof e&&e()})},v=c.get("clientId");v||(v="client:"+system.guid.newGuid(),c.set("clientId",v));var y={events:{}};y.chats=[{id:0,title:"Public",messages:[]}];var _,D=function(){y.chats[y.options.selected].messages&&y.chats[y.options.selected].messages.length&&y.chats[y.options.selected].messages.forEach(function(e){var t=new system.time.timeSpan(new Date,new Date(e.time)),n=parseInt(t.getMinutes());e.timeLeft=n>0?n+" мин.":"только что"})},M=function(){p.query({},function(e){e&&e.length&&(e.sort(function(e,t){var n=function(e){var t=new system.time.timeSpan(new Date,new Date(e));return t.timeDiff};return n(e.time)<=n(t.time)}),e.forEach(function(e){var t=parseInt(new system.time.timeSpan(new Date,new Date(e.time)).getMinutes());y.chats[0].messages.push({text:e.message,userName:e.userName,timeLeft:t>0?t+" мин.":"только что",photo:e.photoPath,time:system.time.convertToUTCDate(new Date(e.time)),sent:e.clientId===v})}),g(f))}),_=s(D,6e4)},L=new a("chatHub",{listeners:{sendPublic:function(e,n,o,r){l(0,e,n,o,r),t.$apply(),g(f)},sendPrivate:function(e,t,n,o,r){h(e,t,n,o,r)},sendSelf:function(e,n,o,r){d(e,n,o,r),t.$apply(),g(f)}},methods:["sendAsync","sendPrivateAsync"],errorHandler:function(e){console.error(e)},hubDisconnected:function(){L.connection.lastError&&L.connection.start()},transport:"webSockets",logging:!0});L.connection.qs={userId:u.userData.isAuth?u.userData.id:v};var w=function(){for(var e=1;e<y.chats.length;e++)y.chats.splice(e,1)};return u.onLogout(function(){w(),L.disconnect(),L.connection.qs={userId:v},L.connect()}),u.onGetUserData(function(){L.disconnect(),L.connection.qs={userId:u.userData.id},L.connect(),w(),u.userData.isAuth&&p.privateChats({},function(e){e&&e.length&&(e.forEach(function(t){var n=t.toUserId;n===u.userData.id&&(n=t.fromUserId);var o,r=e.filter(function(e){return e.toUserId===u.userData.id&&e.fromUserId===n||e.fromUserId===u.userData.id&&e.toUserId===n});r.forEach(function(e){e.userName!==u.userData.userName&&(o=e.userName)}),y.open(n,o);var a=parseInt(new system.time.timeSpan(new Date,new Date(t.time)).getMinutes());y.chats[y.options.selected].messages.push({text:t.message,userName:y.chats[y.options.selected].title,timeLeft:a>0?a+" мин.":"только что",photo:t.photoPath,time:new Date(t.time),sent:t.fromUserId===u.userData.id})}),i(function(){g(f)},500))})}),y.send=function(e,t,n){0===y.chats[y.options.selected].id?L.sendAsync(v,t,e,n):L.sendPrivateAsync(y.chats[y.options.selected].id,t,e,n)},y.options={visible:!0,title:"Чат",selected:0},y.init=M,y.open=function(e,t){y.options.visible=!0;var n=y.chats.filter(function(t){return t.id===e});if(n.length){var o=y.chats.getIndexByPropertyValue("id",e);y.options.selected=o}else y.chats.push({id:e,title:t,messages:[]}),y.options.selected=y.chats.length-1},y.events.onMessageAdded=m,M(),y}]),app.service("errorService",function(e){var t=function(t,n){return t&&t.data&&t.data.error_description?t.data.error_description:t.statusText||n||e.LOGIN_UNRECOGNIZED_ERROR},n=function(t,n){return t&&t.data&&t.data.message?t.data.message:t.statusText||n||e.UNEXPECTED_SERVER_ERROR},o=function(e){if(e.data&&e.data.modelState){var t=[];for(var o in e.data.modelState)if(e.data.modelState.hasOwnProperty(o))for(var r=0;r<e.data.modelState[o].length;r++)t.push(e.data.modelState[o][r]);return t.join("; ")}return n(e)};this.parseAuthResponse=t,this.parseDataResponse=n,this.parseFormResponse=o}),app.service("mapService",function(e,t,n,o,r,a,s,i,c,u){function l(){D&&D.set("directions",null),M&&M.set("directions",null)}function h(e){W.push(e)}function d(e){z.push(e)}function p(e){V.push(e)}function f(){V.length&&V.forEach(function(e){"function"==typeof e&&e()})}function m(){y&&o(function(){g.event.trigger(y,"resize"),X()},100)}var g,v,y,_,D,M,L,w,S,k,C,A,R,E,N,T,x,b,U,O=[],I=[],P={highlightMyRoutes:!0},F=[{colors:["#047D28","#0FAB3E","#06C941"],markerImage:"content/images/glyphicons-563-person-walking.png"},{colors:["#00CFFD","#00B1FD","#006EFD"],markerImage:"content/images/glyphicons-6-car.png"}],H={highlight:"#FC5400",search:"#E300D4",temp:"#FF5900"},G=[],V=[],W=[],z=[],j=t.defer(),B=t.defer(),q={center:{latitude:49.1451,longitude:35.668},zoom:4,control:{},bounds:{}},Y=function(e){for(var t="",n="",o=0;o<e.address_components.length;o++)$.inArray("route",e.address_components[o].types)>=0&&(t=e.address_components[o].short_name),$.inArray("street_number",e.address_components[o].types)>=0&&(n=e.address_components[o].short_name);return t+" "+n},K=function(e,o,r){if(o&&e.address&&(e.address=R.city+", "+e.address),r)return n.get("https://maps.googleapis.com/maps/api/geocode/json",{params:e});var a=t.defer();return v.geocode(e,function(e,t){t===g.GeocoderStatus.OK?a.resolve(e):a.reject(t)}),a.promise},Z=function(e,t,n){y.panTo(new g.LatLng(e,t)),y.setZoom(n)},X=function(){navigator.geolocation.getCurrentPosition(function(e){Z(e.coords.latitude,e.coords.longitude,12);var t=new g.LatLng(e.coords.latitude,e.coords.longitude);K({latLng:t}).then(function(e){R={};for(var t=e[0].address_components,n=0;n<t.length;n++)$.inArray("country",t[n].types)>=0&&(R.country=t[n].short_name),$.inArray("locality",t[n].types)>=0&&(R.city=t[n].short_name)})},function(){},{enableHighAccuracy:!0,timeout:2e3})},J=function(e,t,n,o,r){var a=n&&n.indexOf("to")>-1?"B":"A",s=n&&n.indexOf("Search")>-1?"EDED0C":"2DE02D",i=new g.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld="+a+"|"+s,null,null,null,new g.Size(24,37)),c={icon:o||i,latitude:e,longitude:t,title:"Test",options:r?{title:r}:{draggable:!0,animation:g.Animation.DROP}};c.id=n;for(var u=null,l=0;l<I.length;l++)if(I[l].id===n){u=l;break}null!=u?(I[u].latitude=e,I[u].longitude=t):I.push(c)},Q=function(e){for(var t=[],n=e.legs,o=0;o<n.length;o++)for(var r=n[o].steps,a=0;a<r.length;a++)for(var s=r[a].path,i=0;i<s.length;i++)t.push({Lat:s[i].lat(),Lng:s[i].lng()});return{path:t}},ee=function(e,n){var o=t.defer(),r={draggable:!n,preserveViewport:!1,polylineOptions:{strokeColor:n?H.search:H.temp,strokeOpacity:n?.5:1,strokeWeight:7,zIndex:1e3}},a=new g.DirectionsRenderer(r);a.setMap(y),n?M=a:D=a;var s={origin:e.startLatLng,destination:e.endLatLng,travelMode:g.TravelMode.DRIVING},i=new g.DirectionsService;return i.route(s,function(e,t){if(t===g.DirectionsStatus.OK){a.setDirections(e),g.event.addListener(a,"directions_changed",function(){z.length&&z.forEach(function(e){"function"==typeof e&&e(a)})});var n=Q(e.routes[0]);n.totalDistance=e.routes[0].legs[0].distance.value,n.totalDuration=e.routes[0].legs[0].duration.value,o.resolve(n)}o.reject()}),o.promise},te=function(){I=[],"function"==typeof E&&E(I)},ne=function(){for(var e=[],t=0;t<I.length;t++)"fromMarker"!==I[t].id&&"toMarker"!==I[t].id&&e.push(I[t]);I=e,"function"==typeof E&&E(I)},oe=function(){for(var e=[],t=0;t<I.length;t++)"fromSearchMarker"!==I[t].id&&"toSearchMarker"!==I[t].id&&e.push(I[t]);I=e,"function"==typeof E&&E(I)},re=function(){for(var e=[],t=0;t<I.length;t++)-1===I[t].id.indexOf("_temp")&&e.push(I[t]);I=e,"function"==typeof E&&E(I)},ae=function(e){for(var t=[],n=0;n<I.length;n++)-1===I[n].id.indexOf("id_"+e)&&t.push(I[n]);I=t,"function"==typeof E&&E(I)},se=function(){O.forEach(function(e){e.polyline.setMap(null)}),te(),O=[]},ie=function(){re(),L&&(L.polyline.setMap(null),L=null)},ce=function(e){return e.isCurrentUserRoute&&P.highlightMyRoutes?H.highlight:F[e.type].colors[Math.floor(Math.random()*F[e.type].colors.length+0)]},ue=function(){O.forEach(function(e){e.polyline.setOptions({strokeColor:ce(e.info)})})},le=function(e){O.forEach(function(t){t.info.id===e&&(t.polyline.setMap(null),t.polyline=null)}),O=O.filter(function(e){return null!==e.polyline}),ae(e)},he=function(){w&&w.isOpen()&&(w.close(),w=null)},de=function(t,n,a){
var i=new g.Polyline({path:t.coords.map(function(e){return new g.LatLng(e.lat,e.lng)}),strokeColor:n?H.highlight:ce(t),strokeOpacity:n?.3:.6,strokeWeight:6});i.setMap(y),g.event.addListener(i,"mouseover",function(t){var n,a=this.getPath().getArray(),i=a[0],c=a[a.length-1];O.forEach(function(e){var t=e.polyline.getPath().getArray();t[0]===i&&t[t.length-1]===c&&(n=e.info)}),_={strokeColor:this.strokeColor,strokeOpacity:this.strokeOpacity,zIndex:1,strokeWeight:5},this.setOptions({strokeColor:"#ffffff",strokeOpacity:1,zIndex:999,strokeWeight:10}),e.highlightedRouteInfo=s.getRouteViewModel(n,!0),e.highlightedRouteInfo.events.onRemove=function(e){return function(){e.remove().then(function(e){le(e),U&&"function"==typeof U&&U(e),he()})}}(e.highlightedRouteInfo);var u="<div><route-view route='highlightedRouteInfo'></route-view></div>",l=r(u)(e);he(),S||(k=o(function(){S&&(w=new g.InfoWindow({disableAutoPan:!1}),w.setPosition(C?new g.LatLng(C.lat()+.003,C.lng()):new g.LatLng(t.latLng.lat()+.003,t.latLng.lng())),w.setContent(l[0]),w.isOpen()||w.open(y)),S=!1},1e3),S=!0)}),g.event.addListener(i,"mousemove",function(e){w&&w.isOpen()&&w.setPosition(new g.LatLng(e.latLng.lat()+.003,e.latLng.lng()))}),g.event.addListener(i,"mouseout",function(){this.setOptions(_),S=!1,o.cancel(k)});var c={polyline:i,info:t};n?L=c:O.push(c);var u=n?"id_"+t.id+"_"+t.startLatLng+"_end_temp":"id_"+t.id+"_"+t.startLatLng+"_end",l=n?"id_"+t.id+"_"+t.endLatLng+"_start_temp":"id_"+t.id+"_"+t.endLatLng+"_start",h=t.coords[t.coords.length-1],d=t.coords[0];J(h.lat,h.lng,u,F[t.type].markerImage,t.endName),J(d.lat,d.lng,l,F[t.type].markerImage,t.startName),a&&Z(d.lat,d.lng,12)},pe=function(e){E=e},fe=function(e){N=e},me=function(e){T=e},ge=function(e){x=e},ve=function(e){U=e},ye=function(e){b=e},_e=function(e){G.push(e)},De=function(e,n,o){if(e.type!=A||!n||o){A=e.type;var r=t.defer();return l(),ie(),se(),s.resource.query(e,function(e){if(e&&e.length){for(var t=0;t<e.length;t++)n&&de(e[t]);r.resolve(e)}r.resolve(0)}),r.promise}},Me=function(){l(),s.resource.mostRecent({},function(e){e&&de(e)})};c.then(function(e){g=e,v=new e.Geocoder}),u.promise().then(function(e){y=q.control.getGMap(),g.event.addListener(y,"mousemove",function(e){C=e.latLng}),initGmapsContextMenu(g);var t={menu:"context_menu",menuSeparator:"context_menu_separator",menuItem:"context_menu_item"},n={id:"map_rightclick",eventName:"menu_item_selected",classNames:t,menuItems:[{label:"Проложить маршрут отсюда",id:"menu_go_from",eventName:"onGoFromClick"},{label:"Проложить маршрут сюда",id:"menu_go_to",eventName:"onGoToClick"},{label:"Искать отсюда",id:"menu_search_from",eventName:"onSearchFromClick"},{label:"Искать сюда",id:"menu_search_to",eventName:"onSearchToClick"},{id:"Separator"},{label:"Сброс",id:"menu_reset",eventName:"onResetClick"}]},o=new googlemaps.ContextMenu(y,n),r=function(e,t,n){J(e.lat(),e.lng(),t),K({latlng:e.lat()+","+e.lng(),language:"ru"},!1,!0).then(function(t){t.data.results&&t.data.results.length&&"function"==typeof n&&n(Y(t.data.results[0]),e)})},a=function(e){e.length&&e.forEach(function(e){"function"==typeof e&&e()})};g.event.addListener(y,"rightclick",function(e){o.show(e.latLng),B.resolve()}),g.event.addListener(o,"onGoFromClick",function(e){r(e,"fromMarker",N)}),g.event.addListener(o,"onGoToClick",function(e){r(e,"toMarker",T)}),g.event.addListener(o,"onSearchFromClick",function(e){r(e,"fromSearchMarker",x)}),g.event.addListener(o,"onSearchToClick",function(e){r(e,"toSearchMarker",b)}),g.event.addListener(o,"onResetClick",function(){a(G)}),j.resolve(e)});var Le={dragend:function(e,t,n){W.length&&W.forEach(function(o){"function"==typeof o&&o(e,t,n)})}},we=function(){O.forEach(function(e){e.polyline.setOptions({strokeOpacity:.3})})},Se=function(){O.forEach(function(e){e.polyline.setOptions({strokeOpacity:.6})})};this.refresh=m,this.addRoute=f,this.onAddRoute=p,this.map=q,this.markers=I,this.centerOnMe=X,this.centerMap=Z,this.geocode=K,this.setMarker=J,this.setRoute=de,this.clearAll=se,this.clearTemp=ie,this.declareRoute=ee,this.ready=j.promise,this.contextMenuReady=B.promise,this.onMapMarkersChanged=pe,this.onFromMarkerSelected=fe,this.onToMarkerSelected=me,this.onSearchFromMarkerSelected=ge,this.onSearchToMarkerSelected=ye,this.onRouteRemoved=ve,this.onResetSelected=_e,this.onMarkerDrag=h,this.onRouteChanged=d,this.clearTempDirection=l,this.removeMarkers=te,this.removeRouteMarkers=ne,this.removeSearchMarkers=oe,this.showRoutes=De,this.showMostRecentRoute=Me,this.markerEvents=Le,this.getShortAddress=Y,this.maskRoutes=we,this.unmaskRoutes=Se,this.displayOptions=P,this.updateHighlight=ue,this.removeRoute=le}),app.service("routeService",function(e,t,n,o,r){var a=e("/:action",{action:"api/route"},{mostRecent:{method:"GET",params:{action:"api/route/mostRecent"}}}),s=function(e,s){var i=new hitcher.viewModels.routeViewModel(e);return i.config={showUserPhoto:s},i.photoPath=r.cdnMediaBase+i.photoPath,i.events={onApply:function(){o.open(i.userId,i.driver)}},i.remove=function(){var e=t.defer(),o=this,r=n({template:"app/views/modal/yes-no-dialog.html",show:!1});return r.$scope.title="Удаление маршрута",r.$scope.content="Вы в своём уме?",r.$scope.yes=function(){var t=this;a["delete"]({id:o.model.id},function(n){t.$hide(),e.resolve(o.model.id)},function(t){this.$hide(),e.reject()})},r.$promise.then(r.show),e.promise},i};this.getRouteViewModel=s,this.resource=a}),app.service("statusService",function(e,t){var n={message:"",status:"success"},o=function(e,o){t.complete(),n.message=e,n.status=o},r=function(t){e({content:t,placement:"top-right",type:"success",duration:3,show:!0})},a=function(e){o(e,"warning")},s=function(t){e({content:t||"Unable to connect to service",placement:"top-right",type:"danger",duration:3,show:!0})},i=function(e){o(e,"info"),t.start()},c=function(){t.complete(),n.message=""},u=function(t){e({content:t,placement:"top-right",type:"info",duration:3,show:!0})};this.info=u,this.set=o,this.state=n,this.success=r,this.loading=i,this.warning=a,this.error=s,this.clear=c}),app.service("userService",function(e,t){var n={type:0};this.user=n}),app.service("authInterceptorService",["$q","$location","localStorageService","appConst",function(e,t,n,o){var r=function(e){if(e.headers=e.headers||{},e.url.indexOf("photo")>-1&&(e.headers["Content-Type"]="multipart/form-data"),-1===e.url.indexOf("google")){var t=n.get("authorizationData");t&&(e.headers.Authorization="Bearer "+t.token)}return e},a=function(n){return 401===n.status&&t.path("/login"),e.reject(n)};this.request=r,this.responseError=a}]),Array.prototype.getIndexByPropertyValue=function(e,t){for(var n=0;n<this.length;n+=1)if(this[n][e]===t)return n},system.format=function(){var e=function(t,n){for(var o in t)t.hasOwnProperty(o)&&t[o]&&(isNaN(t[o])?t[o]instanceof Object&&e(t[o],n):t[o]=parseFloat(t[o].toFixed(n)))};return{setPrecision:e}}(),system.guid=function(){var e=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})};return{newGuid:e}}(),system.json=function(){var e=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},t=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t};return{getKeys:e,getValues:t}}(),function(){this.system=this.system||{}}(),system.string=function(){function e(e,t,n){return null==e||""===e||null==t||""===t?-1:("string"!=typeof e&&(e=String(e)),"string"!=typeof t&&(t=String(t)),t.length>e.length?-1:(n||(e=e.toLowerCase(),t=t.toLowerCase()),e===t?0:e.indexOf(t)))}var t=/([a-z])([A-Z])/g,n=/([_ ]+)([a-z])/gi,o=/^[-]?\d*\.?\d*$/g,r=Array.prototype.slice;return{toTitleCase:function(e){return e&&e.length>1?e.charAt(0).toUpperCase()+e.substr(1).replace(t,"$1 $2").replace(n,function(e,t,n){return" "+n.toUpperCase()}):e},capitalize:function(e){return e?1===e.length?e.toUpperCase():e.charAt(0).toUpperCase()+e.substr(1):e},startsWith:function(t,n,o){return 0===e(t,n,o)},contains:function(t,n,o){return e(t,n,o)>=0},format:function(e){if(!e||arguments.length<2)return e;var t,n,o,a;for(t=2===arguments.length&&Array.isArray(arguments[1])?arguments[1]:r.call(arguments,1),n=/\{0\}/.test(e)?0:1,o=t.length;o--;)a=new RegExp("\\{"+(o+n)+"\\}","g"),e=e.replace(a,null==t[o]?"":t[o]);return e},escapeHtml:function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},repeat:function(e,t){return Array(e+1).join(t)},isNumeric:function(e){return e?e.toString().match(o):!1}}}(),String.prototype.toHHMMSS=function(){var e=parseInt(this,10),t=Math.floor(e/3600),n=Math.floor((e-3600*t)/60),o=e-3600*t-60*n;10>t&&(t="0"+t),10>n&&(n="0"+n),10>o&&(o="0"+o);var r=t+":"+n+":"+o;return r},system.time=function(){function e(e){var t=new Date(e.getTime()+60*e.getTimezoneOffset()*1e3),n=e.getTimezoneOffset()/60,o=e.getHours();return t.setHours(o-n),t}function t(e){return new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds())}var n=function(e,t){if(!(e instanceof Date&&t instanceof Date))throw"Invalid input params";this.timeDiff=e.getTime()-t.getTime()};return n.prototype.getSeconds=function(){return this.timeDiff/1e3},n.prototype.getMinutes=function(){return this.timeDiff/6e4},n.prototype.getHours=function(){return this.timeDiff/36e5},{timeSpan:n,convertUTCDateToLocalDate:e,convertToUTCDate:t}}();