app.controller("accountController",["$scope","$location","authService","errorService","appConst","msgConst","statusService",function(e,t,o,r,a,n,s){function u(){e.securityFormData={oldPassword:"",password:"",confirmPassword:""}}s.clear(),o.userData.isAuth||t.path("/login");var c=new Date;c.setDate(c.getDate()-4380),e.maxDate=c,e.formData=o.userData,u(),e.photoWidth=a.userPhotoWidth,e.onFilesAdded=function(){return-1===arguments[0][0].file.type.indexOf("image")||arguments[0][0].size>2e7?(s.info("You are allowed to upload only image files up to 20 Mb size"),!1):(this.$flow.defaults.headers.Authorization=o.getAuthHeader(),!0)},e.onUploadProgress=function(){s.loading("Uploading photo...")},e.onUploadSuccess=function(e,t){s.success("User photo is updated successfully"),o.setPhoto(t.split('"').join(""))},e.deleteUserModal={title:"Delete Confirmation",content:n.ACCOUNT_DELETE,yes:function(){var e=this;o.auth["delete"]({},function(){e.$hide(),t.path("/home"),o.logout()},function(e){this.$hide(),s.error(r.parseDataError(e))})}},e.update=function(){o.auth.update(e.formData,function(){s.success(n.ACCOUNT_UPDATE_SUCCESS)},function(e){s.error(r.parseFormResponse(e))})},e.changePassword=function(){o.auth.updatePassword(e.securityFormData,function(){u(),s.success(n.ACCOUNT_PWD_CHANGE_SUCCESS)},function(e){u(),s.error(r.parseFormResponse(e))})}}]),app.controller("controlCtrl",["$scope","mapService","authService","userService",function(e,t,o,r){e.danger=!1,e.userData=o.userData,e.user=r.user,e.authData=o.userData,e.displayOptions=t.displayOptions,t.ready.then(function(){e.$watch("displayOptions.highlightMyRoutes",function(){t.updateHighlight()})}),e.addRoute=function(){t.addRoute()},e.handleCenterMe=function(){t.centerOnMe()}}]),app.controller("homeController",["$scope",function(e){var t=e.slides=[];t.push({image:"/content/images/lp_1.jpg",text:"Альтернатива такси есть..."}),t.push({image:"/content/images/lp_2.jpg",text:"Путешевствуйте вместе..."}),t.push({image:"/content/images/lp_3.jpg",text:"Надоело ездить на шестерке?"}),t.push({image:"/content/images/lp_4.jpg",text:"Путешевствуйте между городами и даже странами"}),t.push({image:"/content/images/lp_7.jpg",text:"Найдите попутчика внутри города"}),t.push({image:"/content/images/lp_5.jpg",text:"Надоело ездить на ланосе?"}),t.push({image:"/content/images/lp_6.jpg",text:"Надоело ездить на Тойоте?"}),e.myInterval=5e3}]),app.controller("indexController",["$scope","$location","$aside","authService","userService","routeService","mapService","statusService","chatService",function(e,t,o,r,a,n,s,u,c){function l(){e.searchModel={from:null,to:null,take:2,disableFilter:!1,hideFilter:!1,currentUserOnly:!1}}function i(t){e.searchModel.routes&&e.searchModel.routes.length&&(e.searchModel.routes=e.searchModel.routes.filter(function(e){return e.model.id!==t}))}var d=c.options;e.chatToggle=function(){d.visible=!d.visible},e.searchAside=null,e.alert={title:"Holy guacamole!",content:"Best check yo self, you're not looking too good.",type:"info"};var h=function(){e.searchAside||(e.searchAside=o({scope:e,backdrop:!1,dismissable:!1,placement:"right",template:"app/views/modal/search.html"}),e.searchAside.$promise.then(function(){e.searchAside.show()}))};e.user=a.user;var g=function(){e.searchAside&&(l(),s.removeSearchMarkers(),s.clearTempDirection(),e.searchAside.hide(),e.searchAside=null,s.showRoutes({type:1-e.user.type},!0,!0))};r.onLogout(g),e.$on("$routeChangeSuccess",function(){e.mapVisible=!arguments[1].loadedTemplateUrl||"/map"===arguments[1].redirectTo,e.mapVisible||g()});var m=function(){t.path("/map"),l(),e.searchModel.hideFilter=!0,e.searchModel.currentUserOnly=!0,h(),e.search()};e.userMenu=[{text:"Профайл",href:"#/account",target:"_self"},{text:"Мои маршруты",click:m},{divider:!0},{text:"Выйти",click:"logout()"}],e.markerEvents=s.markerEvents,s.onMarkerDrag(function(t){var o=t.position,r=t.key;if("fromSearchMarker"===r||"toSearchMarker"===r){var a={latlng:o.lat()+","+o.lng(),language:"ru"};s.geocode(a,!1,!0).then(function(t){"fromSearchMarker"===r?(e.searchModel.from=t.data.results[0].formatted_address,e.searchModel.startLat=o.lat(),e.searchModel.startLng=o.lng()):"toSearchMarker"===r&&(e.searchModel.to=t.data.results[0].formatted_address,e.searchModel.endLat=o.lat(),e.searchModel.endLng=o.lng())})}}),e.authData=r.userData,e.logout=function(){r.logout(),t.path("/home")},s.ready.then(function(){e.$watch("user.type",function(t){e.searchAside&&e.hideSearch(),s.showRoutes({type:1-t},!0)})}),s.onRouteRemoved(function(e){i(e)}),s.contextMenuReady.then(function(){e.$watch("searchModel.startLat",function(t){$("#menu_search_from").length&&($("#menu_search_from")[0].style.display=t?"none":"block"),$("#menu_search_to").length&&($("#menu_search_to")[0].style.display=t?"block":"none");var o=$("#menu_go_from").length&&"none"===$("#menu_go_from")[0].style.display&&e.authData.isAuth||$("#menu_search_from").length&&"none"===$("#menu_search_from")[0].style.display?"block":"none";$("#menu_reset").length&&($("#menu_reset")[0].style.display=o),$(".context_menu_separator").length&&($(".context_menu_separator")[0].style.display=o)}),e.$watch("searchModel.endLat",function(){$("#menu_search_to").length&&($("#menu_search_to")[0].style.display=e.searchModel.startLat&&e.searchModel.endLat||!e.searchModel.startLat?"none":"block")}),s.onSearchFromMarkerSelected(function(t,o){e.searchModel.from=t,e.searchModel.startLat=o.lat(),e.searchModel.startLng=o.lng(),e.searchModel.startLatLng=o,h()}),s.onSearchToMarkerSelected(function(t,o){e.searchModel.to=t,e.searchModel.endLat=o.lat(),e.searchModel.endLng=o.lng(),e.searchModel.endLatLng=o,h()}),s.onResetSelected(function(){e.searchAside&&e.hideSearch()})}),l(),e.getAddress=function(e){var t={address:e,region:"UA",language:"ru"};return s.geocode(t,!0,!0).then(function(e){return e.data.results})},e.search=function(){e.searchModel.type=1-a.user.type,s.showRoutes(e.searchModel).then(function(t){var o=[],r=null;if(t&&t.length){for(var a=0;a<t.length;a++){var c=n.getRouteViewModel(t[a]);c.canDelete=!1,c.canChat=!1,c.events.mouseenter=function(e){return function(){e.canDelete=e.model.isCurrentUserRoute,e.canChat=!e.model.isCurrentUserRoute,s.setRoute(e.model,!0,!0)}}(c),c.events.mouseout=function(e){return function(){e.canDelete=e.model.isCurrentUserRoute&&e.isActive,e.canChat=!e.model.isCurrentUserRoute&&e.isActive,s.clearTemp()}}(c),c.events.click=function(e){return function(){r&&(r.isActive=!1,r.canDelete=!1,r.canChat=!1),s.clearAll(),e.isActive=!0,e.canDelete=e.model.isCurrentUserRoute,e.canChat=!e.model.isCurrentUserRoute,s.setRoute(e.model,!1,!0),r=e}}(c),c.events.onRemove=function(e){return function(){e.remove().then(function(e){i(e),s.removeRoute(e)})}}(c),o.push(c)}o[0].isActive=!0,o[0].canDelete=o[0].model.isCurrentUserRoute,o[0].canChat=!o[0].model.isCurrentUserRoute,s.setRoute(o[0].model,!1,!0),r=o[0]}else u.info("Подходящих результатов не найдено");e.searchModel.disableFilter=!0,e.searchModel.routes=o}),e.searchModel&&e.searchModel.startLatLng&&e.searchModel.endLatLng&&s.declareRoute(e.searchModel,!0)},e.$on("$typeahead.select",function(t,o){e.searchModel.from===o?s.geocode({address:e.searchModel.from}).then(function(t){var o=t[0].geometry.location;e.searchModel.startLat=o.lat(),e.searchModel.startLng=o.lng(),s.setMarker(o.lat(),o.lng(),"fromSearchMarker"),s.centerMap(o.lat(),o.lng(),12)}):e.searchModel.to===o&&s.geocode({address:e.searchModel.to}).then(function(t){var o=t[0].geometry.location;e.searchModel.endLat=o.lat(),e.searchModel.endLng=o.lng(),s.setMarker(o.lat(),o.lng(),"toSearchMarker"),s.centerMap(o.lat(),o.lng(),12)})}),e.hideSearch=g,e.onSearchClick=function(){e.searchAside?e.searchModel.hideFilter?(l(),s.removeSearchMarkers(),s.clearAll()):e.hideSearch():h()}}]),app.controller("loginController",["$scope","$location","$alert","statusService","authService","errorService","appConst","msgConst",function(e,t,o,r,a,n,s,u){e.formData={userName:"",password:""},e.login=function(){a.login(e.formData).then(function(){t.path("/map")},function(t){e.formData={userName:"",password:""},r.error(n.parseAuthResponse(t))})},e.forgotPasswordModal={title:"Password recovery",editable:!0,input:"",content:u.LOGIN_PWD_RECOVERY_INSTRUCTIONS,yes:function(){var e=this;a.auth.resetPassword({email:e.input,callbackLink:location.protocol+"//"+location.host+"/#/login"},function(){e.$hide(),r.success(system.string.format(u.LOGIN_PWD_RECOVERY_LINK_SENT_FORMAT,e.input))},function(t){e.$hide(),r.error(n.parseDataResponse(t))})}},e.externalLogin=function(t){var o=location.protocol+"//"+location.host+"/authcomplete.html",r="/api/auth/externalLogin?provider="+t+"&response_type=token&client_id=Hitcher&redirect_uri="+o;window.$windowScope=e,window.open(r,"Authenticate Account","location=0,status=0,width=600,height=750")},e.authCompletedCB=function(o){e.$apply(function(){a.obtainAccessToken({provider:o.provider,externalAccessToken:o.external_access_token,userId:o.user_id}).then(function(){t.path("/map")},function(e){r.error(n.parseDataResponse(e))})})}}]),app.controller("mapController",["$scope","$route","$alert","$aside","$http","$modal","$q","$timeout","$interval","userService","authService","mapService","statusService","routeService","chatService",function(e,t,o,r,a,n,s,u,c,l,i,d,h,g,m){function p(){var t=new Date;t.setHours(t.getHours()+1);var o=new Date;o.setMonth(o.getMonth()+1),e.route={startName:null,endName:null,name:e.userData.userName,phone:e.userData.phoneNumber,startTime:t,recurrency:!1,recurrencyMode:1,recurrencyWeeklyMon:!0,recurrencyWeeklyTue:!0,recurrencyWeeklyWed:!0,recurrencyWeeklyThr:!0,recurrencyWeeklyFri:!0,recurrencyWeeklySat:!0,recurrencyWeeklySun:!0,recurrencyInterval:1,dueDate:o,recurrencyModes:[{value:0,label:"Каждый день"},{value:1,label:"Каждую неделю"},{value:2,label:"Каждый месяц"}]}}var f,v=!1;e.map=d.map,e.markers=d.markers,e.markerEvents=d.markerEvents,e.userData=i.userData,e.chatOptions=m.options,e.chatMessage="",e.chatMessages=m.all,e.chats=m.chats;var M=function(t){$("#menu_go_from").length&&($("#menu_go_from")[0].style.display=t?e.userData.isAuth?"block":"none":e.userData.isAuth&&"block"===$("#menu_go_from")[0].style.display?"block":"none"),$("#menu_go_to").length&&($("#menu_go_to")[0].style.display=e.userData.isAuth&&"block"===$("#menu_go_to")[0].style.display?"block":"none")};e.$watch("userData.isAuth",function(){M(!0)}),e.$on("$routeChangeSuccess",function(){e.mapVisible=!arguments[1].loadedTemplateUrl||"/map"===arguments[1].redirectTo}),e.$watch("mapVisible",function(t){t?d.refresh():e.hideDriveAside(),M(!0)}),e.user=l.user,d.onMarkerDrag(function(t){var o=t.position,r=t.key;if("fromMarker"===r||"toMarker"===r){var a={latlng:o.lat()+","+o.lng(),language:"ru"};d.geocode(a,!1,!0).then(function(t){"fromMarker"===r?(e.route.startName=d.getShortAddress(t.data.results[0]),e.route.startLatLng=o):"toMarker"===r&&(e.route.endName=d.getShortAddress(t.data.results[0]),e.route.endLatLng=o)})}});var y=function(){e.route.name=e.userData.userName,e.route.phone=e.userData.phoneNumber,f&&f.$isShown||(f=r({scope:e,backdrop:!1,dismissable:!1,placement:"left",template:"app/views/modal/aside.html"}),f.$promise.then(function(){f.show()}),d.maskRoutes())};e.hideDriveAside=function(){f&&(p(),d.removeRouteMarkers(),d.clearTempDirection(),v=!1,f.hide(),d.unmaskRoutes())},e.toggleAside=function(){f&&f.$isShown?e.hideDriveAside():y()},e.declareRoute=function(){e.route.type=l.user.type,e.route.startLatLng=e.route.startLatLng.lat()+","+e.route.startLatLng.lng(),e.route.endLatLng=e.route.endLatLng.lat()+","+e.route.endLatLng.lng(),e.route.totalDistance=e.route.totalDistanceToSave,e.route.totalDuration=e.route.totalDurationToSave;var t=e.route.totalDistance/1e3;if(t>=10){var o=4;t>50&&75>=t?o=3:t>75&&100>=t?o=2:t>100&&(o=1);for(var r=Math.floor(t*o),a=Math.floor(e.route.path.length/r),n=[],s=0;s<e.route.path.length;s++)(0===s||s===e.route.path.length-1||s%a===0)&&n.push(e.route.path[s]);e.route.path=n}g.resource.save(e.route,function(e){e&&h.success("Route is successfully created."),p(),f.hide(),v=!1,d.showMostRecentRoute()})},e.getAddress=function(e){var t={address:e,region:"UA",language:"ru"};return d.geocode(t,!0,!0).then(function(e){return e.data.results})},d.onMapMarkersChanged(function(t){e.markers=t}),d.onFromMarkerSelected(function(t,o){e.route.startName=t,e.route.startLatLng=o,y()}),d.onToMarkerSelected(function(t,o){e.route.endName=t,e.route.endLatLng=o,y()}),d.onResetSelected(function(){f&&f.$isShown&&e.hideDriveAside()}),d.onAddRoute(function(){f&&f.$isShown?e.hideDriveAside():y()}),i.onLogout(e.hideDriveAside);var _=function(){d.declareRoute(e.route).then(function(t){return t?(e.route.path=t.path,e.route.totalDistanceToSave=t.totalDistance,e.route.totalDistance=Math.floor(t.totalDistance/1e3)+" км, "+t.totalDistance%1e3+" м",e.route.totalDurationToSave=t.totalDuration,e.route.totalDuration=t.totalDuration.toString().toHHMMSS(),d.removeRouteMarkers(),void(v=!0)):(p(),void h.info("Невозможно проложить маршрут."))})};e.$on("$typeahead.select",function(t,o){e.route.startName===o?d.geocode({address:e.route.startName}).then(function(t){var o=t[0].geometry.location;e.route.startLatLng=o,d.setMarker(o.lat(),o.lng(),"fromMarker"),d.centerMap(o.lat(),o.lng(),12),v&&(d.clearTempDirection(),_())}):e.route.endName===o&&d.geocode({address:e.route.endName}).then(function(t){var o=t[0].geometry.location;e.route.endLatLng=o,d.setMarker(o.lat(),o.lng(),"toMarker"),d.centerMap(o.lat(),o.lng(),12),v&&(d.clearTempDirection(),_())})}),d.ready.then(function(){d.centerOnMe(),e.$watch("user.type",function(){f&&f.$isShown&&e.hideDriveAside()})}),d.contextMenuReady.then(function(){e.$watch("route.startLatLng",function(t){$("#menu_go_from").length&&($("#menu_go_from")[0].style.display=t?"none":"block"),$("#menu_go_to").length&&($("#menu_go_to")[0].style.display=t?"block":"none");var o=$("#menu_go_from").length&&"none"===$("#menu_go_from")[0].style.display&&e.userData.isAuth||$("#menu_search_from").length&&"none"===$("#menu_search_from")[0].style.display?"block":"none";$("#menu_reset").length&&($("#menu_reset")[0].style.display=o),$(".context_menu_separator").length&&($(".context_menu_separator")[0].style.display=o),M()}),e.$watch("route.endLatLng",function(){$("#menu_go_to").length&&($("#menu_go_to")[0].style.display=e.route.startLatLng&&e.route.endLatLng||!e.route.startLatLng?"none":"block"),M()})}),e.$watch("route.startLatLng",function(){e.route.endLatLng&&e.route.startLatLng&&!v&&_()}),e.$watch("route.endLatLng",function(){e.route.endLatLng&&e.route.startLatLng&&!v&&_()}),d.onRouteChanged(function(t){var o=t.getDirections();if(o){for(var r=[],a=o.routes[0].legs,n=0;n<a.length;n++)for(var s=a[n].steps,u=0;u<s.length;u++)for(var c=s[u].path,l=0;l<c.length;l++)r.push({Lat:c[l].lat(),Lng:c[l].lng()});e.route.path=r,e.route.startLatLng=o.nc.origin,e.route.endLatLng=o.nc.destination;var i=o.routes[0].legs[0].distance.value;e.route.totalDistanceToSave=i,e.route.totalDistance=Math.floor(i/1e3)+" км, "+i%1e3+" м";var h=o.routes[0].legs[0].duration.value;e.route.totalDurationToSave=h,e.route.totalDuration=h.toString().toHHMMSS(),d.geocode({latlng:e.route.startLatLng.lat()+","+e.route.startLatLng.lng(),language:"ru"},!1,!0).then(function(t){e.route.startName=d.getShortAddress(t.data.results[0])}),d.geocode({latlng:e.route.endLatLng.lat()+","+e.route.endLatLng.lng(),language:"ru"},!1,!0).then(function(t){e.route.endName=d.getShortAddress(t.data.results[0])})}}),p()}]),app.controller("signupController",["$scope","$location","$timeout","msgConst","errorService","authService","statusService",function(e,t,o,r,a,n,s){s.clear(),e.success=!1,e.submitted=!1,e.formData={userName:"",email:"",password:"",confirmPassword:""},e.signUp=function(){function u(){e.success=!0,s.success(system.string.format(r.SIGNUP_SUCCESS_FORMAT,e.formData.userName));var a=function(){var e=o(function(){o.cancel(e),t.path("/login")},5e3)};a()}function c(e){s.error(a.parseFormResponse(e))}e.submitted=!0,n.logout(),n.auth.save(e.formData,u,c)}}]);